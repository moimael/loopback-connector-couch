{"version":3,"sources":["couch.js"],"names":[],"mappings":"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","file":"couch.js","sourcesContent":["var {_} = require('lodash');\nvar debug = require('debug')('loopback:connector:couch');\nvar helpers = require('./helpers.js');\n\n// api\nexports.initialize = function(dataSource, callback) {\n  var connector = new CouchConnector(dataSource, callback);\n\n  if (callback) {\n    dataSource.connector.connect(callback);\n  }\n};\n\n//Constructor and useful reference functions\nclass CouchConnector {\n  constructor(dataSource) {\n\n    var ref;\n    var ref1;\n    var ref2;\n    this.relational = false;\n    this.dataSource = dataSource;\n    dataSource.connector = this;\n\n    var settings = dataSource.settings || {};\n    this.settings = settings;\n    helpers.optimizeSettings(settings);\n\n    if (((ref = settings.auth) != null) ? ref.reader : undefined) {\n      this._nanoReader = require('nano')(this.buildAuthUrl(settings.auth.reader));\n    }\n    if (((ref1 = settings.auth) != null) ? ref1.writer : undefined) {\n      this._nanoWriter = require('nano')(this.buildAuthUrl(settings.auth.writer));\n    }\n    if (((ref2 = settings.auth) != null) ? ref2.admin : undefined) {\n      this._nanoAdmin = require('nano')(this.buildAuthUrl(settings.auth.admin));\n    }\n\n    if (!this._nanoReader) {\n      this._nanoReader = require('nano')(this.buildAuthUrl(settings.auth));\n    }\n    if (!this._nanoWriter) {\n      this._nanoWriter = require('nano')(this.buildAuthUrl(settings.auth));\n    }\n    if (!this._nanoAdmin) {\n      this._nanoAdmin = require('nano')(this.buildAuthUrl(settings.auth));\n    }\n\n    this._models = {};\n    this.name = 'couchdb';\n    if (settings.views && _.isArray(settings.views)) {\n      this.DataAccessObject = function() {};\n      //add existing methods\n      if (dataSource.constructor.DataAccessObject) {\n        for (var k in dataSource.constructor.DataAccessObject) {\n          var v = dataSource.constructor.DataAccessObject[k];\n          this.DataAccessObject[k] = v;\n        }\n        for (var k in dataSource.constructor.DataAccessObject.prototype) {\n          v = dataSource.constructor.DataAccessObject.prototype[k];\n          this.DataAccessObject.prototype[k] = v;\n        }\n      }\n      //then add connector method\n      var viewFn = this.buildViewEndpoint(settings.views);\n      this.DataAccessObject.queryView = viewFn;\n      dataSource.queryView = viewFn;\n    }\n\n    return this;\n  }\n\n  getDefaultIdType() {\n    return String;\n  }\n\n  getTypes() {\n    return ['db', 'nosql', 'couchdb'];\n  }\n\n  getMetadata() {\n    if (!this._metaData) {\n      this._metaData = {\n        types: this.getTypes(),\n        defaultIdType: this.getDefaultIdType(),\n        isRelational: this.relational,\n        schemaForSettings: {}\n      };\n    }\n    return this._metaData;\n  }\n\n  define(descr) {\n    var modelName = descr.model.modelName;\n\n    this._models[modelName] = descr;\n    descr.properties._rev = {\n      type: String\n    };\n    // Add index views for schemas that have indexes\n    var design = {\n      views: {}\n    };\n    var hasIndexes = false;\n    for (var propName in descr.properties) {\n      var value = descr.properties[propName];\n      if (value.index) {\n        hasIndexes = true;\n        var viewName = helpers.viewName(propName);\n        design.views[viewName] = {\n          map: 'function (doc) { if (doc.loopbackModel === \\'' + modelName + '\\' && doc.'+propName + ') return emit(doc.' + propName + ', null); }'\n        };\n      }\n    }\n    if (hasIndexes) {\n      var designName = '_design/' + helpers.designName(modelName);\n      return helpers.updateDesign(this._nanoAdmin, designName, design);\n    }\n  }\n\n//Loopback.io prototype functions\n  connect(callback) {\n    var design = {\n      views: {\n        by_model: {\n          map: 'function (doc) { if (doc.loopbackModel) return emit(doc.loopbackModel, null); }'\n        }\n      }\n    };\n\n    if (this.dataSource.connecting) {\n      this.dataSource.once('connected', function() {\n        process.nextTick(function () {\n          callback && callback(null, null);\n        });\n      });\n    } else {\n      helpers.updateDesign(this._nanoAdmin, '_design/loopback', design, (err, res) => {\n        process.nextTick(function () {\n          callback && callback(err, res);\n        });\n      });\n    }\n  };\n\n  create(model, data, callback) {\n    debug('CouchDB create');\n    return this.save(model, data, callback);\n  }\n\n  save(model, data, callback) {\n    debug('CouchDB save');\n    if (!data) {\n      return callback && callback('Cannot create an empty document in the database');\n    }\n    delete data._deleted;     // Prevents accidental deletion via save command\n    return this._nanoWriter.insert(this.forDB(model, data), (err, rsp) => {\n      if (err) {\n        return callback(err);\n      }\n      // Undo the effects of savePrep as data object is the only one\n      // that the Loopback.io can access.\n      helpers.undoPrep(data);\n      // Update the data object with the revision returned by CouchDb.\n      data._rev = rsp.rev;\n      return callback && callback(null, rsp.id, rsp.rev);\n    });\n  }\n\n  updateOrCreate(model, data, callback) {\n    debug('CouchDB updateOrCreate');\n    delete data._deleted;    // Prevents accidental deletion\n    return this.save(model, data, function(err, id, rev) {\n      if (err) {\n        return callback && callback(err);\n      }\n      data.id = id;\n      data._rev = rev;\n      return callback && callback(null, data);\n    });\n  }\n\n  update(model, where, data, callback) {\n    debug('CouchDB update');\n    delete data._deleted;    // Prevents accidental deletion\n    return this.all(model, {where}, (err, docsFromDb) => {\n      if (err) {\n        return callback && callback(err);\n      }\n      helpers.merge(docsFromDb, data);\n      if (!_.isArray(docsFromDb)) {\n        docsFromDb = [docsFromDb];\n      }\n      var docs = ((() => {\n        var result = [];\n        for (var i = 0, doc; i < docsFromDb.length; i++) {\n          doc = docsFromDb[i];\n          result.push(this.forDB(model, doc));\n        }\n        return result;\n      })());\n      debug(docs);\n      return this._nanoWriter.bulk({docs}, function(err, rsp) {\n        return callback && callback(err, rsp);\n      });\n    });\n  }\n\n  updateAttributes(model, id, attributes, callback) {\n    debug('CouchDB updateAttributes');\n    delete attributes._deleted;  //prevent accidental deletion\n    return this._nanoReader.get(id, (err, doc) => {\n      if (err) {\n        return callback && callback(err);\n      }\n      return this.save(model, helpers.merge(doc, attributes), function(err, rsp) {\n        if (err) {\n          return callback && callback(err);\n        }\n        doc._rev = rsp.rev;\n        return callback && callback(null, doc);\n      });\n    });\n  }\n\n  destroyAll(model, where, callback) {\n    debug('CouchDB destroyAll');\n    return this.all(model, {where}, (err, docs) => {\n      if (err) {\n        return callback && callback(err);\n      }\n      debug(docs);\n      docs = (() => {\n        var result = [];\n        for (var i = 0, doc; i < docs.length; i++) {\n          doc = docs[i];\n          result.push({_id: doc.id, _rev: doc._rev, _deleted: true});\n        }\n        return result;\n      })();\n      return this._nanoWriter.bulk({docs}, function(err, rsp) {\n        return callback && callback(err, rsp);\n      });\n    });\n  }\n\n  count(model, callback, where) {\n    debug('CouchDB count');\n    return this.all(model, {where}, (err, docs) => {\n      if (err) {\n        return callback && callback(err);\n      }\n      return callback && callback(null, docs.length);\n    });\n  }\n\n  all(model, filter, callback) {\n    var id;\n    var ref;\n    var where;\n    debug('CouchDB all');\n    debug(filter);\n    // Consider first the easy case that a specific id is requested\n    ref = (typeof filter !== 'undefined' && filter !== null) ? filter.where : undefined\n    if (id = (ref != null && typeof ref.id !== 'object') ? ref.id : undefined) {\n      debug('...moving to findById from all');\n      // support include filter\n      if ((typeof filter !== 'undefined' && filter !== null) ? filter.include : undefined) {\n        return this.findById(model, id, (err, result) => {\n          if (err) {\n            return callback(err);\n          }\n          return this._models[model].model.include(result, filter.include, callback);\n        });\n      } else {\n        return this.findById(model, id, callback);\n      }\n    }\n\n    var params = {\n      keys: [model],\n      include_docs: true\n    };\n\n    if (filter.offset && !filter.where) {\n      params.skip = filter.offset;\n    }\n    //if you have a where clause and a limit first get all the data and then limit them\n    if (filter.limit && !filter.where) {\n      params.limit = filter.limit;\n    }\n\n    // We always fallback on loopback/by_model view as it allows us\n    // to iterate over all the docs for a model. But check if\n    // there is a specialized view for one of the where conditions.\n    var designName = 'loopback';\n    var viewName = 'by_model';\n    if (where = ((typeof filter !== 'undefined' && filter !== null) ? filter.where : undefined)) {\n      var props = this._models[model].properties;\n      for (var propName in where) {\n        // We can use an optimal view when a where \"clause\" uses an indexed property\n        var value = where[propName];\n        if (value && (props[propName] != null) && props[propName].index) {\n          // Use the design and view for the model and propName\n          designName = helpers.designName(model);\n          viewName = helpers.viewName(propName);\n          // support loopback passing inq key arrays\n          if ((value.inq != null)) {\n            params.keys = [];\n            for (var i = 0, key; i < value.inq.length; i++) {\n              key = value.inq[i];\n              params.keys.push(_.isDate(key) ? key.getTime() : key);\n            }\n          } else {\n            // CouchDb stores dates as Unix time\n            params.key = _.isDate(value) ? value.getTime() : value;\n            // We don't want to use keys - we now have a key property\n            delete params.keys;\n          }\n          break;\n        }\n      }\n    }\n\n    return this._nanoReader.view(designName, viewName, params, (err, body) => {\n      var orders;\n      if (err) {\n        return callback && callback(err);\n      }\n      var docs = (() => {\n        var result = [];\n        for (var j = 0, row; j < body.rows.length; j++) {\n          row = body.rows[j];\n          row.doc.id = row.doc._id;\n          delete row.doc._id;\n          result.push(row.doc);\n        }\n        return result;\n      })();\n\n\n      debug('CouchDB all: docs before where');\n      debug(docs);\n\n      if (where = ((typeof filter !== 'undefined' && filter !== null) ? filter.where : undefined)) {\n        docs = _.filter(docs, (doc) => {\n          var isMatch = true;\n          for (var k in where) {\n            // CouchDb stores dates as Unix time\n            var v = where[k];\n            if (_.isDate(v)) {\n              where[k] = v.getTime();\n            }\n            // support loopback inq queries\n            if (where[k].inq) {\n              if (!_.includes(where[k].inq, doc[k])) {\n                isMatch = false;\n              }\n            } else {\n              if (doc[k] !== where[k]) {\n                isMatch = false;\n              }\n            }\n          }\n          return isMatch;\n        });\n      }\n\n      debug('CouchDB all: docs after where');\n      debug(docs);\n\n      if (orders = ((typeof filter !== 'undefined' && filter !== null) ? filter.order : undefined)) {\n        if (_.isString(orders)) { orders = [orders]; }\n        var sorting = function(a, b) {\n          var iterable = this;\n          for (var i = 0, item; i < iterable.length; i++) {\n            item = iterable[i];\n            var ak;\n            var bk;\n            var rev;\n            ak = a[this[i].key], bk = b[this[i].key], rev = this[i].reverse;\n            if (ak > bk) {\n              return 1 * rev;\n            }\n            if (ak < bk) {\n              return -1 * rev;\n            }\n          }\n          return 0;\n        };\n\n        for (var i = 0, key; i < orders.length; i++) {\n          key = orders[i];\n          orders[i] = {\n            reverse: helpers.reverse(key),\n            key: helpers.stripOrder(key)\n          };\n        }\n\n        docs.sort(sorting.bind(orders));\n      }\n\n      var maxDocsNum;\n      var startDocsNum;\n\n      if (((typeof filter !== 'undefined' && filter !== null) ? filter.limit : undefined) && ((typeof filter !== 'undefined' && filter !== null) ? filter.where : undefined)) {\n        maxDocsNum = filter.limit;\n      } else {\n        maxDocsNum = docs.length;\n      }\n      if (((typeof filter !== 'undefined' && filter !== null) ? filter.offset : undefined) && ((typeof filter !== 'undefined' && filter !== null) ? filter.where : undefined)) {\n        startDocsNum = filter.offset;\n      } else {\n        startDocsNum = 0;\n      }\n\n      docs = docs.slice(startDocsNum, maxDocsNum);\n      var output = ((() => {\n        var result = [];\n        for (var j = 0, doc; j < docs.length; j++) {\n          doc = docs[j];\n          result.push(this.fromDB(model, doc));\n        }\n        return result;\n      })());\n\n      // support include filter\n      if ((typeof filter !== 'undefined' && filter !== null) ? filter.include : undefined) {\n        return this._models[model].model.include(output, filter.include, callback);\n      } else {\n        return callback(null, output);\n      }\n    });\n  }\n\n\n  forDB(model, data = {}) {\n    helpers.savePrep(model, data);\n    var props = this._models[model].properties;\n    for (var k in props) {\n      var v = props[k];\n      if (data[k] && props[k].type.name === 'Date' && (data[k].getTime != null)) {\n        data[k] = data[k].getTime();\n      }\n    }\n    return data;\n  }\n\n  fromDB(model, data) {\n    if (!data) {\n      return data;\n    }\n    helpers.undoPrep(data);\n    var props = this._models[model].properties;\n    for (var k in props) {\n      var v = props[k];\n      if ((data[k] != null) && props[k].type.name === 'Date') {\n        var date = new Date(data[k]);\n        date.setTime(data[k]);\n        data[k] = date;\n      }\n    }\n    return data;\n  }\n\n  exists(model, id, callback) {\n    debug('CouchdDB exists');\n    return this._nanoReader.head(id, function(err, _, headers) {\n      if (err) {\n        return callback && callback(null, 0);\n      }\n      return callback && callback(null, 1);\n    });\n  }\n\n  getLatestRevision(model, id, callback) {\n    return this._nanoReader.head(id, function(err, _, headers) {\n      if (err) {\n        return callback && callback(err);\n      }\n      var rev = headers.etag.substr(1, headers.etag.length - 2);\n      return callback && callback(null, rev);\n    });\n  }\n\n  destroy(model, id, callback) {\n    debug('CouchDB destroy');\n    return this.getLatestRevision(model, id, (err, rev) => {\n      if (err) {\n        return callback && callback(err);\n      }\n      return this._nanoWriter.destroy(id, rev, (err, rsp) => {\n        return callback && callback(err, rsp);\n      });\n    });\n  }\n\n  findById(model, id, callback) {\n    debug('CouchDB findById');\n    return this._nanoReader.get(id, (err, doc) => {\n      debug(err, doc);\n      if (err && err.statusCode === 404) {\n        return callback && callback(null, []);\n      }\n      if (err) {\n        return callback && callback(err);\n      }\n      return callback && callback(null, [(this.fromDB(model, doc))]);  // Uses array as this function is called by all who needs to return array\n    });\n  }\n\n  viewFunction(model, ddoc, viewname, keys, callback) {\n    ddoc = ddoc ? ddoc : this.settings.database || this.settings.db;\n    var view = _.findWhere(this._availableViews, {ddoc: ddoc, name: viewname});\n\n    if (!view) {\n      return callback && callback('The requested view is not available in the datasource');\n    }\n    var params = keys;\n    if (typeof keys === 'function') {\n      callback = keys;\n      params = {};\n    }\n    if (typeof keys === 'string') {\n      params = {keys: [keys]};\n    }\n    if (_.isArray(keys)) {\n      params = {keys: keys};\n    }\n\n\n    debug(model, ddoc, viewname, params);\n\n    return this._nanoReader.view(ddoc, viewname, params, (err, rsp) => {\n      if (err) {\n        return callback && callback(err);\n      }\n      var docs = _.pluck(rsp.rows, 'value');\n      return callback && callback(null, ((() => {\n        var result = [];\n        for (var i = 0, doc; i < docs.length; i++) {\n          doc = docs[i];\n          result.push(this.fromDB(model, doc));\n        }\n        return result;\n      })()));\n    });\n  }\n\n  buildViewEndpoint(views) {\n    this._availableViews = views;\n    var fn = _.bind(this.viewFunction, this);\n    fn.accepts = [\n      {\n        arg: 'modelName',\n        type: 'string',\n        description: 'The current model name',\n        required: false,\n        http(ctx) {\n          return ctx.method.sharedClass.name;\n        }\n      },\n      {\n        arg: 'ddoc',\n        type: 'string',\n        description: 'The design document name for the requested view. Defaults to CouchDB database name used for this data.',\n        required: false,\n        http: {\n          source: 'query'\n        }\n      },\n      {\n        arg: 'viewname',\n        type: 'string',\n        description: 'The view name requested.',\n        required: true,\n        http: {\n          source: 'query'\n        }\n      },\n      {\n        arg: 'keys',\n        type: 'object',\n        description: 'The index(es) requested to narrow view results. Parameter can be a string, array of strings or object with \\'key\\' or with \\'startkey\\' and \\'endkey\\', as per CouchDB. Use the object version for complex keys querying.',\n        required: false,\n        http: {\n          source: 'query'\n        }\n      }\n    ];\n    fn.returns = {\n      arg: 'items',\n      type: 'array'\n    };\n    fn.shared = true;\n    fn.http = {\n      path: '/queryView',\n      verb: 'get'\n    };\n    fn.description = 'Query a CouchDB view based on design document name, view name and keys.';\n    return fn;\n  }\n\n  buildAuthUrl(auth) {\n    var authString;\n    if (auth && (auth.username || auth.user) && (auth.password || auth.pass)) {\n      authString = (auth.username || auth.user) + ':' + (auth.password || auth.pass) + '@';\n    } else {\n      authString = '';\n    }\n    var url = this.settings.protocol + '://' + authString + this.settings.hostname + ':' + this.settings.port + '/' + this.settings.database;\n    return url;\n  }\n}\n"],"sourceRoot":"/source/"}